<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Json Web Token | Valan&#39;s TIL</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/TIL/logo.png">
    <meta name="description" content="Valan&#39;s Log (Today I Learned)">
    
    <link rel="preload" href="/TIL/assets/css/0.styles.4ad97e71.css" as="style"><link rel="preload" href="/TIL/assets/js/app.5396d23b.js" as="script"><link rel="preload" href="/TIL/assets/js/2.f6b4a306.js" as="script"><link rel="preload" href="/TIL/assets/js/13.bf7e381f.js" as="script"><link rel="prefetch" href="/TIL/assets/js/10.0ca2e1dc.js"><link rel="prefetch" href="/TIL/assets/js/11.f12ffd2e.js"><link rel="prefetch" href="/TIL/assets/js/12.4c69d4f6.js"><link rel="prefetch" href="/TIL/assets/js/14.e274b398.js"><link rel="prefetch" href="/TIL/assets/js/15.6f2aa68a.js"><link rel="prefetch" href="/TIL/assets/js/16.84a5f646.js"><link rel="prefetch" href="/TIL/assets/js/17.ea36164a.js"><link rel="prefetch" href="/TIL/assets/js/18.4234f063.js"><link rel="prefetch" href="/TIL/assets/js/19.957dd52d.js"><link rel="prefetch" href="/TIL/assets/js/20.2db943ce.js"><link rel="prefetch" href="/TIL/assets/js/21.2e9572f3.js"><link rel="prefetch" href="/TIL/assets/js/22.116ea66e.js"><link rel="prefetch" href="/TIL/assets/js/23.19e05d9b.js"><link rel="prefetch" href="/TIL/assets/js/24.4a94c460.js"><link rel="prefetch" href="/TIL/assets/js/25.13483f29.js"><link rel="prefetch" href="/TIL/assets/js/26.b51b8160.js"><link rel="prefetch" href="/TIL/assets/js/27.5b7b6474.js"><link rel="prefetch" href="/TIL/assets/js/28.4ad27200.js"><link rel="prefetch" href="/TIL/assets/js/29.799b19b5.js"><link rel="prefetch" href="/TIL/assets/js/3.d30423c5.js"><link rel="prefetch" href="/TIL/assets/js/30.5f299f79.js"><link rel="prefetch" href="/TIL/assets/js/31.d5144d43.js"><link rel="prefetch" href="/TIL/assets/js/32.af080d7a.js"><link rel="prefetch" href="/TIL/assets/js/33.47839320.js"><link rel="prefetch" href="/TIL/assets/js/34.db91d9ff.js"><link rel="prefetch" href="/TIL/assets/js/35.da116349.js"><link rel="prefetch" href="/TIL/assets/js/36.cc90b1dc.js"><link rel="prefetch" href="/TIL/assets/js/37.8ccc477c.js"><link rel="prefetch" href="/TIL/assets/js/38.c3d3d6de.js"><link rel="prefetch" href="/TIL/assets/js/39.16f908c0.js"><link rel="prefetch" href="/TIL/assets/js/4.219e07a0.js"><link rel="prefetch" href="/TIL/assets/js/40.0cd50b1b.js"><link rel="prefetch" href="/TIL/assets/js/41.c255915b.js"><link rel="prefetch" href="/TIL/assets/js/42.362e5ea1.js"><link rel="prefetch" href="/TIL/assets/js/43.cfc86107.js"><link rel="prefetch" href="/TIL/assets/js/44.d7c52867.js"><link rel="prefetch" href="/TIL/assets/js/45.9a892c11.js"><link rel="prefetch" href="/TIL/assets/js/46.d8714425.js"><link rel="prefetch" href="/TIL/assets/js/5.c02b90a5.js"><link rel="prefetch" href="/TIL/assets/js/6.0c27c4d2.js"><link rel="prefetch" href="/TIL/assets/js/7.d34c5bdd.js"><link rel="prefetch" href="/TIL/assets/js/8.53b6bcf8.js"><link rel="prefetch" href="/TIL/assets/js/9.5b3fda29.js">
    <link rel="stylesheet" href="/TIL/assets/css/0.styles.4ad97e71.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/TIL/" class="home-link router-link-active"><!----> <span class="site-name">Valan's TIL</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://valanlog.notion.site/Valan-b91bd2f277ef4c10b4327839af2b865d" target="_blank" rel="noopener noreferrer" class="nav-link external">
  RESUME
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://valanlog.notion.site/Valan-b91bd2f277ef4c10b4327839af2b865d" target="_blank" rel="noopener noreferrer" class="nav-link external">
  RESUME
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Flutter</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React.js</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Next.js</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Debug</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Etc</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/TIL/Etc/json_web_token.html" aria-current="page" class="active sidebar-link">Json Web Token</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/TIL/Etc/eslint_build_error.html" class="sidebar-link">빌드 시 ESLint error 무시하기</a></li><li><a href="/TIL/Etc/eslint_quites_setting.html" class="sidebar-link">ESLint 따옴표 설정 변경 (quotes)</a></li><li><a href="/TIL/Etc/mysql_truncate.html" class="sidebar-link">MySQL table truncate</a></li><li><a href="/TIL/Etc/mysql_foreign_key_constraint.html" class="sidebar-link">MySQL Cannot add foreign key constraint</a></li><li><a href="/TIL/Etc/mysql_create_user.html" class="sidebar-link">MySQL 계정 생성 및 DB 권한 부여</a></li><li><a href="/TIL/Etc/window_ubuntu.html" class="sidebar-link">윈도우에서 Ubuntu 설치 및 WLS 셋팅</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="json-web-token"><a href="#json-web-token" class="header-anchor">#</a> Json Web Token</h1> <p align="right">작성일 : 22.08.28</p> <p>Next.js 로 프로젝트 진행 중, JWT 와 관련된 내용이 나왔다.</p> <p>과거 공부했던 내용들과 새로 추가한 내용들을 정리 차원에서 업로드! 😎</p> <hr> <h3 id="정의"><a href="#정의" class="header-anchor">#</a> 정의</h3> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>JWT는 서버와 클라이언트 간 정보를 주고 받을 때 Http 리퀘스트 헤더에 JSON 토큰을 넣은 후 서버는 별도의 인증 과정없이 헤더에 포함되어 있는 JWT 정보를 통해 인증하는 방식</p></div> <p><img src="https://user-images.githubusercontent.com/107361759/187075025-0ffb8972-a0bc-4e4d-a381-91176e6f354f.png" alt="image"></p> <ol><li><p>헤더: 알고리즘(3번 서명 값을 만드는데 사용될 알고리즘이 지정 ex) HS256), type이 들어감 (언제나 JWT)</p></li> <li><p>페이로드: 토큰이 갖는 데이터</p></li> <li><p>서명 (signature): 1번 헤더에 정의된 알고리즘을 통해 암호화한 비밀 값으로 서버만 알고 있음</p></li></ol> <details><summary>헤더 (Header)</summary> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <ul><li><p>Header 는 두가지의 정보를 지니고 있습니다.</p></li> <li><p>typ: 토큰의 타입을 지정합니다. 바로 JWT를 말하는 것입니다.</p></li> <li><p>alg: Signature 해싱 알고리즘을 지정합니다. 해싱 알고리즘으로는 보통 HMAC-SHA256 혹은 RSA 가 사용되며, 이 알고리즘은 토큰을 검증 할 때 사용되는 signature 부분에서 사용됩니다.</p></li></ul></div> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  <span class="token punctuation">{</span>
  <span class="token string-property property">&quot;typ&quot;</span><span class="token operator">:</span> <span class="token string">&quot;JWT&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;alg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HS256&quot;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></details> <p></p> <details><summary>페이로드 (Payload)</summary> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <ul><li>Payload 부분에는 토큰에 담을 정보가 들어있습니다. 여기에 담는 정보의 한 ‘조각’ 을 클레임(Claim) 이라고 부르고, 이는 Json(Key/Value) 형태의 한 쌍으로 이뤄져있습니다. 토큰에는 여러개의 클레임들을 넣을 수 있습니다.</li> <li>클레임 의 종류는 다음과 같이 크게 세 분류로 나뉘어져있습니다:</li> <li>등록된 (registered) 클레임</li> <li>공개 (public) 클레임</li> <li>비공개 (private) 클레임</li></ul></div> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    <span class="token string-property property">&quot;iss&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dnjscksdn98.com&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;exp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1485270000000&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;https://dnjscksdn98.com/jwt_claims/is_admin&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;userId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dnjscksdn98&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;alex&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></details> <p></p> <details><summary>서명 (Signature)</summary> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <ul><li>서명(Signature)은 토큰을 인코딩하거나 유효성 검증을 할 때 사용하는 고유한 암호화 코드입니다. 서명은 위에서 만든 헤더(Header)와 페이로드(Payload)의 값을 각각 BASE64로 인코딩하고, 인코딩한 값을 비밀 키를 이용해 헤더(Header)에서 정의한 알고리즘으로 해싱을 하고, 이 값을 다시 BASE64로 인코딩하여 생성합니다.</li></ul></div> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  <span class="token punctuation">{</span>
  <span class="token string-property property">&quot;typ&quot;</span><span class="token operator">:</span> <span class="token string">&quot;JWT&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;alg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HS256&quot;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></details> <p><img src="https://user-images.githubusercontent.com/107361759/187075389-cddf2072-b26e-47be-8882-b733f4fb1dd0.png" alt="image"></p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <ol><li>사용자가 아이디와 비밀번호로 로그인을 한다.</li> <li>서버 측에서 해당 정보를 검증한다.</li> <li>정보가 정확하다면 서버 측에서 사용자에게 Signed 토큰을 발급한다. (Signed는 해당 토큰이 서버에서 정상적으로 발급된 토큰임을 증명하는 Signature를 가지고 있다는 것)</li> <li>클라이언트 측에서 전달받은 토큰을 저장해두고, 서버에 요청을 할 때마다 해당 토큰을 서버에 함께 전달한다. 이때 Http 요청 헤더에 토큰을 포함시킨다.</li> <li>서버는 토큰을 검증하고, 요청에 응답한다.</li></ol></div> <h3 id="종류"><a href="#종류" class="header-anchor">#</a> 종류</h3> <details><summary>JWS</summary>
:::tip
<p>JWS는 Header.Payload.Signature 구조를 가지고 있는 일반적인 JWT 를 말함.</p> <p>:::</p> <p><img src="https://user-images.githubusercontent.com/107361759/187082358-0a733978-dca4-44c1-8a1a-e84d492c7f9f.png" alt="image"></p></details> <details><summary>JWE</summary>
:::tip
<p>JWS가 Claims 를 암호화 하지 않고, Base 64 로 인코딩만 할 뿐이라 사용자 정보가 누출될 수 있다. 이를 개선하기 위해 데이터를 암호화 한 것이 JWE다.</p> <p>:::</p> <p><img src="https://user-images.githubusercontent.com/107361759/187082389-3b35525b-b630-4c16-9c80-783c35b041d2.png" alt="image"></p></details> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 구분방법</span>

<span class="token operator">**</span> 구분 방법 <span class="token operator">**</span>

<span class="token number">1.</span> <span class="token constant">JWS</span>는 <span class="token number">3</span>개로 분류되고<span class="token punctuation">,</span> <span class="token constant">JWE</span>는 <span class="token number">5</span>개로 분류 되기 때문에 각각 <span class="token string">'.'</span>문자가 <span class="token number">2</span>개<span class="token punctuation">,</span> <span class="token number">4</span>개 존재합니다<span class="token punctuation">.</span>

<span class="token number">2.</span> Header의 arg 파라미터 값이 <span class="token constant">JWS</span>는 <span class="token constant">RSA</span><span class="token punctuation">,</span> <span class="token constant">SHA256</span> 등이 존재하지만 <span class="token constant">JWE</span>는
Key Encryption<span class="token punctuation">,</span> Key Wrapping<span class="token punctuation">,</span> Direct Key Agreement를 나타냅니다<span class="token punctuation">.</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="장점"><a href="#장점" class="header-anchor">#</a> 장점</h3> <ol><li>무상태성(Stateless) &amp; 확장성(Scalability)</li></ol> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token operator">-</span> 토큰은 클라측에 저장되기 때문에<span class="token punctuation">,</span> 서버는 완전히 Stateless 하다<span class="token punctuation">.</span>
<span class="token operator">-</span> 서버와의 연결고리가 없기 때문에 <span class="token function">확장</span><span class="token punctuation">(</span>분산<span class="token punctuation">)</span>하기에 용이하다<span class="token punctuation">.</span>
<span class="token operator">-</span> 토큰 기반 인증 시스템이 아니라면<span class="token punctuation">,</span> 처음 로그인 했었던 서버에만 세션 정보가 있기 때문에
  그 서버로만 요청을 받도록 설정을 해주어야 한다<span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ol start="2"><li>CORS 문제 해결</li></ol> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token operator">-</span> 세션 기반 인증 시스템의 문제점 중 하나인 <span class="token constant">CORS</span>를 해결할 수 있다<span class="token punctuation">.</span>
<span class="token operator">-</span> 서비스 규모가 커지면 여러 종류의 서비스와 여러 디바이스 호환을 제공해야 하는데<span class="token punctuation">,</span> 토큰을 
  사용한다면 어떤 도메인에서도 유효성 검사를 진행한 후 요청 처리 할 수 있다<span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="3"><li>서버 리소스</li></ol> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token operator">-</span> 세션 기반 인증 시스템은 이용자의 세션을 메모리상이나 <span class="token constant">DB</span><span class="token punctuation">,</span> 로컬 스토리지 등에 저장하게 된다<span class="token punctuation">.</span>
<span class="token operator">-</span> So<span class="token punctuation">,</span> 동시 접속자 수가 많아질 수록 서버에 부하가 많이 가게 된다<span class="token punctuation">.</span>
<span class="token operator">-</span> <span class="token constant">JWT</span> 는 서버에 토큰을 저장하지 않기 때문에<span class="token punctuation">,</span> 비교적 부하가 덜 하다<span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="단점"><a href="#단점" class="header-anchor">#</a> 단점</h3> <ol><li>토큰 자체에 정보가 담겨 있다.</li></ol> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token operator">-</span> 토큰 자체에 정보가 담겨있기 때문에<span class="token punctuation">,</span> 보안에 취약할 수 있다는 단점이 있다<span class="token punctuation">.</span>
<span class="token operator">-</span> 서버쪽에 저장되어있지 않고 클라쪽에 저장되어 있기 때문에<span class="token punctuation">,</span> 서버 측에서 토큰을 제어할 수
  있는 방법도 없다<span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>⇒ So, 이런 단점을 보완하기 위해서 Access Token, Refresh Token 을 각각 발급해서 처리하기도 한다.</p> <ul><li>이용자가 로그아웃을 하게 되면, Access Token 을 사용하지 못하게 blacklist table 에 저장하기도 한다.</li></ul> <ol><li>Payload 인코딩</li></ol> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token operator">-</span> 페이로드 자체는 암호화 된 것이 아니라<span class="token punctuation">,</span> <span class="token constant">BASE64</span>로 인코딩 된 것이기 때문에<span class="token punctuation">,</span>
  중간에 Payload를 탈취하면 Data를 볼 수 있다<span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>⇒ So, 이런 단점을 보완하기 위해서 JWE로 Payload 의 데이터를 한번 더 암호화 하기도 한다. + Payload에 이용자 비밀번호와 같은 중요 데이터를 넣지 않는다.</p> <details><summary>
JWT 는 세션을 완전 대체하지 못한다??
</summary> <p><img src="https://user-images.githubusercontent.com/107361759/187082594-c2578996-b58e-4f86-9b46-989dc1501c53.png" alt="image"></p></details> <h3 id="구현시-신경써야-할-점"><a href="#구현시-신경써야-할-점" class="header-anchor">#</a> 구현시 신경써야 할 점</h3> <ol><li>XSS 공격</li></ol> <ul><li><p>공격자(해커)가 클라이언트 브라우저에 Javascript를 삽입해 실행하는 공격이다.</p></li> <li><p>공격자가 <code>&lt;input&gt;</code> 을 통해 Javascript를 서버로 전송해 서버에서 스크립트를 실행하거나, url에 Javascript를 적어 클라이언트에서 스크립트 실행이 가능하다면 공격자가 사이트에 스크립트를 삽입해 XSS 공격을 할 수 있다.</p></li> <li><p>이때 공격자는 Javascript를 통해 사이트의 글로벌 변숫값을 가져오거나 그 값을 이용해 사이트인 척 API 콜을 요청할 수도 있다. 다시 말하면 공격자의 코드가 내 사이트의 로직인 척 행동할 수 있다는 거다.</p></li></ul> <ol start="2"><li>CSRF 공격</li></ol> <ul><li><p>공격자가 다른 사이트에서 우리 사이트의 API 콜을 요청해 실행하는 공격이다.</p></li> <li><p>API 콜을 요청할 수 있는 클라이언트 도메인이 누구인지 서버에서 통제하고 있지 않다면 CSRF가 가능한데, 이때 공격자가 클라이언트에 저장된 유저 인증정보를 서버에 보낼 수 있다면, 제대로 로그인한 것처럼 유저의 정보를 변경하거나 유저만 가능한 액션들을 수행할 수 있다.</p></li> <li><p>예를 들어 CSRF에 취약한 은행 사이트가 있다면 로그인한 척 계좌 비밀번호를 바꾸거나 송금을 보낼 수 있는 것이다.</p></li></ul> <h3 id="브라우저-저장소-종류와-보안-이슈"><a href="#브라우저-저장소-종류와-보안-이슈" class="header-anchor">#</a> 브라우저 저장소 종류와 보안 이슈</h3> <ul><li><p>LocalStorage 저장 방식</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code>브라우저 저장소에 저장하는 방식이다<span class="token punctuation">.</span> Javascript 내 글로벌 변수로 
읽기 <span class="token operator">/</span> 쓰기 접근이 가능하다<span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>😈 : localStorage 안에 세션 id, refreshToken 또는 accessToken을 저장해두면
XSS 취약점을 통해 그 안에 담긴 값을 불러오거나, 불러온 값을 이용해 API 콜을 위조할 수 있다.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>쿠키 저장 방식</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code>브라우저에 쿠키로 저장되는데<span class="token punctuation">,</span> 클라이언트가 <span class="token constant">HTTP</span> 요청을 보낼 때마다 자동으로 
쿠키가 서버에 전송된다<span class="token punctuation">.</span> Javascript 내 글로벌 변수로 읽기 <span class="token operator">/</span> 쓰기 접근이 가능하다<span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>  😈 : 쿠키 저장 방식 역시 안에 세션 id, refreshToken, accessToken을 
저장해두면 XSS 취약점이 있을 때 담긴 값들을 불러오거나, API 콜을 보내면 쿠키에 
담긴 값들이 함께 전송되어 로그인한 척 공격을 수행할 수 있다.

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>  😈 : 쿠키에 세션 id나 accessToken을 저장해 인증에 이용하는 구조에 CSRF 취약점이 있다면
 인증 정보가 쿠키에 담겨 서버로 보내진다. 공격자는 유저 권한으로 정보를 가져오거나 액션을
 수행할 수 있다.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>  😇 : 쿠키에 refreshToken만 저장하고 새로운 accessToken을 받아와 인증에 이용하는 
구조에서는 CSRF 취약점 공격을 방어할 수 있다. refreshToken으로 accessToken을 받아도
  accessToken을 스크립트에 삽입할 수 없다면 accessToken을 사용해 
  유저 정보를 가져올 수 없기 때문이다. → accessToken 은 refreshToken 안에 
  payload로 저장되어있는데, XSS 공격이 불가능하다면, refreshToken 의 payload로 
  접근이 불가능하기 때문인 듯.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li> <li><p>secure / httpOnly 쿠키 저장 방식</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code>브라우저에 쿠키로 저장되는 건 같지만<span class="token punctuation">,</span> Javascript 내에서 접근이 불가능하다<span class="token punctuation">.</span> 
secure을 적용하면 https 접속에서만 동작한다<span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>😇 : httpOnly 쿠키 방식으로 저장된 정보는 XSS 취약점 공격으로 담긴 값을 불러올 수 없다.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>😇 : httpOnly 쿠키 역시 refreshToken만 저장하고 accessToken을 
받아와 인증에 이용하는 구조로 CSRF 공격 방어가 가능하다.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>😈 : 쿠키 저장 방식과 같은 이유로 세션 id, accessToken은 저장하면 안 된다.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>😈 : httpOnly 쿠키에 담긴 값에 접근할 수는 없지만 XSS 취약점을 노려 API 콜을 요청하면 
httpOnly 쿠키에 담긴 값들도 함께 보내져 유저인 척 정보를 빼오거나 액션을 수행할 수 있다.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>종합</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>- 종합해보면 세션 `id`를 브라우저에 저장하는 방식은 어떤 방식이던지 보안 위험요소가 있으므로 JWT 이용한 인증 방식을 사용할 것이다. 

- `refreshToken`만을 `secure` `httpOnly` 쿠키에 저장해 CSRF 공격을 방어할 것이다.

- `accessToken`은 웹 어플리케이션 내 로컬 변수에 저장해 사용하며, API를 요청할 때 `Authorization` 헤더에 넣어 보내준다.

- XSS 취약점을 이용한 API 요청 공격은 클라이언트와 서버에서 추가적으로 방어 해야 한다.

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>정리</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>* JWT로 유저 인증

* refreshToken`을 `secure` `httpOnly` 쿠키로, `accessToken`은 JSON payload로 받아와서 웹 어플리케이션 내 로컬 변수로 이용

* 이를 통해 CSRF 취약점 공격 방어하고, XSS 취약점 공격으로 저장된 유저 정보 읽기는 막을 수 있음

* 하지만 XSS 취약점을 통해 API 콜을 보낼 때는 무방비하니 XSS 자체를 막기 위해 서버와 클라이언트 모두 노력해야 함
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li></ul> <h3 id="구현방법-1"><a href="#구현방법-1" class="header-anchor">#</a> 구현방법 1</h3> <p><img src="https://user-images.githubusercontent.com/107361759/187083091-e9581e41-adaa-4157-8d3b-6a837830c13a.png" alt="image"></p> <p><code>AccessToken</code>와 <code>RefreshToken</code>을 이용했다. 두 토큰 모두 JWT이지만 <strong>payload는 다르다</strong>. 사용자는 로그인시 두 토큰을 모두 받고 <code>RefreshToken</code>은 쿠키에 저장하고 <code>AccessToken</code>을 이용해 이후 CRUD작업과 같은 서버의 자원을 활용하는 작업을 진행한다.</p> <p>그러나 <code>next-redux-wrapper</code>는 페이지 이동시 데이터가 휘발되기 때문에 <code>AccessToken</code>을 계속 유지하기 힘든점을 비춰 추가적인 구조가 필요했다. 아래와 같다.</p> <p><img src="https://user-images.githubusercontent.com/107361759/187083127-98e171ea-3d5e-4a0e-b2f8-a95758353af5.png" alt="image"></p> <p>마치 CSRF토큰처럼 <code>AccessToken</code>을 사용한다. 프로젝트의 <code>Feed</code> 페이지 내에서는 글을 올리고 댓글을 작성하고, 글을 삭제하는 등 다양한 작업을 한다. 마치 <strong>SPA</strong>처럼 작동하기 때문에 페이지 내에서 첫 로드 때 받은 <code>AccessToken</code>을 만료기간 내에 사용할 수 있다. 더불어 만료시 자동으로 새로운 토큰을 가져오도록 사용자의 편리상 구현했다.</p> <h3 id="best-옵션"><a href="#best-옵션" class="header-anchor">#</a> Best 옵션 (?)</h3> <p>가장 좋은 방법으로는<code>refresh token</code>을 사용하는 방법이 있다.</p> <p>백엔드 api 개발자와 소통이 가능하다면refresh token을 httpOnly 쿠키로 설정하고url이 새로고침 될 때마다 refresh token을 request에 담아새로운 accessToken을 발급 받는다.발급 받은 accessToken은 js private variable에 저장한다.</p> <p>이런 방식을 사용하는 경우,refresh token이 CSRF에 의해 사용된다 하더라도공격자는 accessToken을 알 수 없다.</p> <p>CSRF는 피해자의 컴퓨터를 제어할 수 있는 것이 아니기 때문이다.요청을 위조하여 피해자가 의도하지 않은서버 동작을 일으키는 공격방법이기 때문에refresh token을 통해 받아온 response(accessToken)는공격자가 확인할 수 없다.</p> <p>따라서 쿠키를 사용하여 XSS를 막고refresh token 방식을 이용하여 CSRF를 막을 수 있다.</p> <p><img src="https://user-images.githubusercontent.com/107361759/187083199-b6a97570-f9c3-45ae-addc-a562e902c928.png" alt="image"></p> <p><img src="https://user-images.githubusercontent.com/107361759/187083213-97a9421d-be26-4e06-ac73-ec490acc190e.png" alt="image"></p> <h3 id="참조"><a href="#참조" class="header-anchor">#</a> 참조</h3> <ul><li><p>참조 :: JWT 기본 개념</p> <p><a href="https://mangkyu.tistory.com/55" target="_blank" rel="noopener noreferrer">https://mangkyu.tistory.com/55<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://velog.io/@syoung125/JWT-%ED%86%A0%ED%81%B0%EC%9D%B4%EB%9E%80" target="_blank" rel="noopener noreferrer">https://velog.io/@syoung125/JWT-토큰이란<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://velog.io/@dnjscksdn98/JWT-JSON-Web-Token-%EC%86%8C%EA%B0%9C-%EB%B0%8F-%EA%B5%AC%EC%A1%B0" target="_blank" rel="noopener noreferrer">https://velog.io/@dnjscksdn98/JWT-JSON-Web-Token-소개-및-구조<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p>참조 :: JWT 구현</p> <p><a href="https://velog.io/@yaytomato/%ED%94%84%EB%A1%A0%ED%8A%B8%EC%97%90%EC%84%9C-%EC%95%88%EC%A0%84%ED%95%98%EA%B2%8C-%EB%A1%9C%EA%B7%B8%EC%9D%B8-%EC%B2%98%EB%A6%AC%ED%95%98%EA%B8%B0" target="_blank" rel="noopener noreferrer">https://velog.io/@yaytomato/프론트에서-안전하게-로그인-처리하기<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://velog.io/@0307kwon/JWT%EB%8A%94-%EC%96%B4%EB%94%94%EC%97%90-%EC%A0%80%EC%9E%A5%ED%95%B4%EC%95%BC%ED%95%A0%EA%B9%8C-localStorage-vs-cookie" target="_blank" rel="noopener noreferrer">https://velog.io/@0307kwon/JWT는-어디에-저장해야할까-localStorage-vs-cookie<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/TIL/Debug/NextJS.html" class="prev">
        NextJS
      </a></span> <span class="next"><a href="/TIL/Etc/eslint_build_error.html">
        빌드 시 ESLint error 무시하기
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/TIL/assets/js/app.5396d23b.js" defer></script><script src="/TIL/assets/js/2.f6b4a306.js" defer></script><script src="/TIL/assets/js/13.bf7e381f.js" defer></script>
  </body>
</html>
